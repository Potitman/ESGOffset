<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>ESG Offset Partners – Global Marketplace for Verified ESG Credits</title>
  <meta name="description" content="ESGOffset.com – global marketplace for verified carbon offsets (biochar removals), renewable energy (reforestation, wind, solar, hydro), plastic credits, and VCUs (VCS v4.4). Build a custom ESG mix, pay via escrow, receive a QR-verifiable retirement certificate."/>
  <link rel="canonical" href="https://www.esgoffset.com/"/>

  <!-- Open Graph -->
  <meta property="og:title" content="ESG Offset Partners"/>
  <meta property="og:description" content="Global marketplace for verified ESG credits."/>
  <meta property="og:type" content="website"/>
  <meta property="og:url" content="https://www.esgoffset.com/"/>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand:{DEFAULT:'#00a36c', soft:'#71d7b0', dark:'#042a1b'} },
          boxShadow:{ soft:'0 6px 30px rgba(0,0,0,.25)'}
        }
      }
    }
  </script>

  <!-- Structured data -->
  <script type="application/ld+json">
  { "@context":"https://schema.org","@type":"Organization","name":"ESG Offset Partners","url":"https://www.esgoffset.com","logo":"https://www.esgoffset.com/assets/logo.png","sameAs":[] }
  </script>

  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 24 24'%3E%3Cpath fill='%2300a36c' d='M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2m4.5 6.5L12 13l-2.5-2.5l-3 3L12 19l7.5-7.5Z'/%3E%3C/svg%3E"/>

  <style>
    .visually-hidden{position:absolute;width:1px;height:1px;margin:-1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0}
    .visually-hidden:focus{position:static;width:auto;height:auto;margin:0;clip:auto;white-space:normal;padding:.5rem .75rem;border-radius:.5rem;background:#0f151b;border:1px solid rgba(255,255,255,.3)}
    /* sliders */
    input[type="range"]{ -webkit-appearance:none; appearance:none; height:36px; background:transparent; width:100% }
    input[type="range"]::-webkit-slider-runnable-track{ height:8px; background:#fff; border-radius:999px; opacity:.95 }
    input[type="range"]::-moz-range-track{ height:8px; background:#fff; border-radius:999px; opacity:.95 }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none; appearance:none; width:26px; height:26px; margin-top:-9px;
      background:#1565C0; border-radius:999px; border:3px solid #0b1116; box-shadow:0 2px 4px rgba(0,0,0,.35)
    }
    input[type="range"]::-moz-range-thumb{ width:26px; height:26px; background:#1565C0; border:none; border-radius:999px }
    .kbd{border:1px solid rgba(255,255,255,.2);padding:.1rem .35rem;border-radius:.375rem;background:rgba(255,255,255,.06);font-size:.8em}
  </style>

  <!-- XLSX (for Excel upload) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-[#0b1116] text-slate-100 antialiased">
<a class="visually-hidden" href="#main">Skip to content</a>

<!-- Header -->
<header class="sticky top-0 z-50 border-b border-white/10 bg-black/50 backdrop-blur supports-[backdrop-filter]:bg-black/40">
  <div class="mx-auto max-w-[1200px] px-4 sm:px-5 h-[64px] flex items-center justify-between">
    <div class="flex items-center gap-2">
      <button id="menuBtn" class="lg:hidden -ml-1 mr-1 p-2 rounded-md border border-white/10 bg-white/5" aria-label="Open menu">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M4 6h16M4 12h16M4 18h16" stroke="#cbd5e1" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
      <svg class="w-7 h-7" viewBox="0 0 24 24" aria-hidden="true"><path fill="#00a36c" d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2m4.5 6.5L12 13l-2.5-2.5l-3 3L12 19l7.5-7.5Z"/></svg>
      <span class="font-semibold tracking-tight">ESG Offset Partners</span>
      <span class="hidden sm:inline-flex ml-2 rounded-md border-emerald-500/40 bg-emerald-500/10 px-2 py-0.5 text-[10px] sm:text-xs text-emerald-100">Global Marketplace</span>
    </div>
    <nav class="hidden lg:flex items-center gap-4">
      <a href="#catalog" class="opacity-90 hover:opacity-100 text-sm">Marketplace</a>
      <a href="#mix" class="opacity-90 hover:opacity-100 text-sm">Build a Mix</a>
      <a href="#how" class="opacity-90 hover:opacity-100 text-sm">How it works</a>
      <a href="#suppliers" class="opacity-90 hover:opacity-100 text-sm">Suppliers</a>
      <a href="#reports" class="opacity-90 hover:opacity-100 text-sm">ESG Reports</a>
      <div class="flex items-center gap-2">
        <button id="loginBtn" class="rounded-full border border-white/20 px-3 py-1.5 text-sm hover:shadow-soft">Log in</button>
        <a href="#cta" class="rounded-full bg-gradient-to-tr from-brand to-brand-soft px-3 py-1.5 text-sm text-brand-dark hover:shadow-soft">Get started</a>
      </div>
    </nav>
  </div>

  <!-- Mobile drawer -->
  <div id="drawer" class="fixed inset-0 z-50 hidden">
    <div id="drawerBackdrop" class="absolute inset-0 bg-black/60"></div>
    <aside class="absolute left-0 top-0 h-full w-[86%] max-w-[360px] bg-[#0c1217] border-r border-white/10 p-4 overflow-y-auto">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <svg class="w-6 h-6" viewBox="0 0 24 24"><path fill="#00a36c" d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2m4.5 6.5L12 13l-2.5-2.5l-3 3L12 19l7.5-7.5Z"/></svg>
          <b>ESG Offset Partners</b>
        </div>
        <button id="menuClose" class="p-2 rounded-md border border-white/10 bg-white/5" aria-label="Close menu">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M6 18L18 6" stroke="#cbd5e1" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <nav class="mt-4 flex flex-col gap-2 text-sm">
        <a class="rounded-md px-3 py-2 hover:bg-white/5" href="#catalog">Marketplace</a>
        <a class="rounded-md px-3 py-2 hover:bg-white/5" href="#mix">Build a Mix</a>
        <a class="rounded-md px-3 py-2 hover:bg-white/5" href="#how">How it works</a>
        <a class="rounded-md px-3 py-2 hover:bg-white/5" href="#suppliers">Suppliers</a>
        <a class="rounded-md px-3 py-2 hover:bg-white/5" href="#reports">ESG Reports</a>
        <div class="h-px bg-white/10 my-2"></div>
        <button id="loginBtnM" class="rounded-md border border-white/15 px-3 py-2 text-left">Log in</button>
        <a href="#cta" class="rounded-md bg-gradient-to-tr from-brand to-brand-soft px-3 py-2 text-brand-dark">Get started</a>
      </nav>
    </aside>
  </div>
</header>

<main id="main">
  <!-- Hero -->
  <section class="mx-auto max-w-[1200px] px-4 sm:px-5 py-8 sm:py-10">
    <div class="grid gap-6 lg:grid-cols-[1.2fr_.8fr] items-start">
      <div>
        <div class="inline-flex items-center gap-2 rounded-full border border-emerald-500/40 bg-emerald-500/10 px-3 py-1 text-emerald-100 text-sm">
          <span>✔</span><span>Verified credits • Registry retirement • White-label certificates</span>
        </div>
        <h1 class="mt-3 text-3xl sm:text-4xl/tight font-semibold">One platform for verified ESG credits — globally.</h1>
        <p class="mt-3 text-slate-300 text-base sm:text-lg leading-relaxed">
          Buy carbon offsets (incl. biochar removals), renewable energy (reforestation, wind, solar, hydro),
          plastic credits, and VCUs (VCS v4.4). Build a custom mix for your ESG reporting. Escrow payments.
          QR-verifiable retirement.
        </p>
        <div class="mt-4 flex flex-wrap gap-2 sm:gap-3">
          <a class="rounded-full bg-gradient-to-tr from-brand to-brand-soft px-4 py-2 text-sm sm:text-base text-brand-dark hover:shadow-soft" href="#mix">Build your ESG mix</a>
          <a class="rounded-full border border-white/20 px-4 py-2 text-sm sm:text-base hover:shadow-soft" href="#catalog">Browse marketplace</a>
          <a class="rounded-full border border-white/20 px-4 py-2 text-sm sm:text-base hover:shadow-soft" href="#suppliers">Sell credits</a>
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
          <span class="rounded-full border border-white/15 bg-white/5 px-3 py-1.5 text-xs sm:text-sm text-slate-300">KYC/AML</span>
          <span class="rounded-full border border-white/15 bg-white/5 px-3 py-1.5 text-xs sm:text-sm text-slate-300">Escrow Payments</span>
          <span class="rounded-full border border-white/15 bg-white/5 px-3 py-1.5 text-xs sm:text-sm text-slate-300">ICVCM & VCMI aligned (in progress)</span>
          <span class="rounded-full border border-white/15 bg-white/5 px-3 py-1.5 text-xs sm:text-sm text-slate-300">ESG-ready exports</span>
        </div>

        <div class="mt-5 grid grid-cols-2 sm:grid-cols-4 gap-3">
          <div class="rounded-xl border border-white/10 bg-white/5 p-3 sm:p-4"><div class="text-[11px] text-slate-400">Live inventory</div><b id="kpi-credits" class="text-base sm:text-lg">—</b></div>
          <div class="rounded-xl border border-white/10 bg-white/5 p-3 sm:p-4"><div class="text-[11px] text-slate-400">Suppliers onboarded</div><b id="kpi-suppliers" class="text-base sm:text-lg">—</b></div>
          <div class="rounded-xl border border-white/10 bg-white/5 p-3 sm:p-4"><div class="text-[11px] text-slate-400">Countries</div><b class="text-base sm:text-lg">3 → Global</b></div>
          <div class="rounded-xl border border-white/10 bg-white/5 p-3 sm:p-4"><div class="text-[11px] text-slate-400">Avg. fulfilment</div><b class="text-base sm:text-lg">~72h</b></div>
        </div>
      </div>

      <!-- Mix Calculator (TONS) -->
      <div id="mix" class="rounded-2xl border border-white/10 bg-gradient-to-b from-[#12171d] to-[#0f1419] p-4 sm:p-5 shadow-soft">
        <!-- AI MIX ADVISOR -->
        <div class="rounded-xl border border-white/10 bg-white/5 p-3 sm:p-4 mb-3">
          <div class="flex items-center justify-between gap-2">
            <h3 class="text-base sm:text-lg font-semibold">AI Mix Advisor</h3>
            <div class="flex items-center gap-2">
              <button id="aiApply" class="rounded-full bg-gradient-to-tr from-brand to-brand-soft px-3 py-2 text-xs sm:text-sm text-brand-dark hover:shadow-soft">Apply preset</button>
              <button id="aiAnalyzeBtn" class="rounded-full border border-white/20 px-3 py-2 text-xs sm:text-sm hover:shadow-soft">Analyze file</button>
            </div>
          </div>
          <p class="mt-1 text-[11px] sm:text-xs text-slate-400">Upload your emissions CSV/XLSX (Scopes 1–3). We’ll estimate needed tCO₂ and recommend a mix.</p>

          <!-- Upload area -->
          <div class="mt-3 grid gap-3 sm:grid-cols-[1fr_auto] items-end">
            <div class="rounded-lg border border-white/15 bg-white/5 p-3">
              <label for="fileInput" class="text-[11px] sm:text-xs text-slate-400">Upload CSV/XLSX (headers: <span class="kbd">scope</span>, <span class="kbd">amount_t</span> OR totals <span class="kbd">scope1_t</span>, <span class="kbd">scope2_location_t</span>, <span class="kbd">scope2_market_t</span>, <span class="kbd">scope3_t</span>)</label>
              <input id="fileInput" type="file" accept=".csv, .xlsx, .xls" class="mt-2 w-full text-sm file:mr-3 file:rounded-md file:border file:border-white/15 file:bg-white/10 file:px-3 file:py-1.5 file:text-slate-200"/>
              <div class="mt-2 text-[11px] sm:text-xs text-slate-400">Or paste CSV below:</div>
              <textarea id="csvTextarea" rows="3" placeholder="scope,amount_t
S1,120
S2,300
S3,950" class="mt-1 w-full rounded-md border border-white/15 bg-transparent p-2 text-xs"></textarea>
              <div class="mt-2 flex flex-wrap gap-2 text-[11px] sm:text-xs">
                <button id="downloadTemplate" class="rounded-full border border-white/20 px-3 py-1 hover:shadow-soft">Download CSV template</button>
                <span class="text-slate-500">Press <span class="kbd">Analyze file</span> to apply results.</span>
              </div>
            </div>
            <div class="space-y-2">
              <div class="rounded-lg border border-white/15 bg-white/5 p-3">
                <div class="text-[11px] text-slate-400">Detected totals</div>
                <div class="mt-1 text-xs">
                  S1: <b id="detS1">—</b> t<br/>
                  S2 (loc): <b id="detS2L">—</b> t<br/>
                  S2 (mkt): <b id="detS2M">—</b> t<br/>
                  S3: <b id="detS3">—</b> t
                </div>
              </div>
              <div class="rounded-lg border border-white/15 bg-white/5 p-3">
                <div class="text-[11px] text-slate-400">Advisor suggestion</div>
                <div class="mt-1 text-xs">
                  Total tCO₂: <b id="suggTotal">—</b><br/>
                  Mix: <b id="suggMix">—</b>
                </div>
                <button id="applySuggestion" class="mt-2 w-full rounded-full bg-gradient-to-tr from-brand to-brand-soft px-3 py-1.5 text-xs text-brand-dark hover:shadow-soft" disabled>Apply to calculator</button>
              </div>
            </div>
          </div>

          <!-- Industry/Goal presets -->
          <div class="mt-3 grid gap-3 sm:grid-cols-2">
            <div>
              <label class="block text-[11px] sm:text-xs text-slate-400 mb-1">Industry</label>
              <select id="aiIndustry" class="w-full rounded-lg border border-white/20 bg-transparent px-3 py-2 text-sm">
                <option value="tech">Tech / SaaS</option>
                <option value="manufacturing">Manufacturing</option>
                <option value="ecommerce">E-commerce / Retail</option>
                <option value="fmcg">FMCG / Food</option>
                <option value="utilities">Utilities / Energy</option>
                <option value="logistics">Logistics / Transport</option>
                <option value="aviation">Aviation</option>
                <option value="construction">Construction / Real estate</option>
                <option value="finance">Finance / Services</option>
                <option value="public">Public sector / Education</option>
                <option value="other">Other / General</option>
              </select>
            </div>
            <div>
              <label class="block text-[11px] sm:text-xs text-slate-400 mb-1">Goal</label>
              <select id="aiGoal" class="w-full rounded-lg border border-white/20 bg-transparent px-3 py-2 text-sm">
                <option value="balanced">Balanced</option>
                <option value="removal">High-removal focus</option>
                <option value="cost">Cost-optimised</option>
                <option value="plastic">Plastic-impact focus</option>
                <option value="brand">Brand/CSR impact</option>
                <option value="science">Science-based (higher removals)</option>
              </select>
            </div>
          </div>
        </div>

        <h3 class="text-lg sm:text-xl font-semibold">Quick ESG Mix Calculator</h3>
        <p id="tierNote" class="mt-1 text-xs text-slate-400">
          Volume-based pricing with built-in markup. Current tier: —. €/t with markup → Biochar —, Renewable —, Plastic —, VCS —.
        </p>

        <!-- Total tonnes -->
        <div class="mt-3 flex items-center gap-3">
          <label for="tonnes" class="text-sm text-slate-300 w-full">Total tCO₂</label>
          <input id="tonnes" type="number" min="1" step="1" value="100"
                 class="w-28 sm:w-40 rounded-lg border border-white/20 bg-transparent px-3 py-2 text-sm sm:text-base"/>
        </div>

        <!-- Remaining pool -->
        <div class="mt-3">
          <div class="flex justify-between text-xs text-slate-400">
            <span>Remaining pool</span>
            <span><b id="remainLabel">100.00</b> t</span>
          </div>
          <div class="mt-1 h-2 rounded-full bg-white/10">
            <div id="remainBar" class="h-2 rounded-full bg-emerald-500" style="width:100%"></div>
          </div>
        </div>

        <!-- Sliders in TONNES (labels show €/t incl. markup) -->
        <div class="mt-4 space-y-4">
          <div>
            <div class="flex items-center justify-between">
              <label for="tBiochar" class="text-sm text-slate-300">Biochar <span id="pBiocharLbl" class="text-slate-400">(€—/t)</span></label>
              <div class="text-xs text-slate-400"><b id="tBiocharLbl">25.00</b> t</div>
            </div>
            <input id="tBiochar" type="range" min="0" max="100" value="25" class="w-full"/>
          </div>

          <div>
            <div class="flex items-center justify-between">
              <label for="tRenew" class="text-sm text-slate-300">Renewable Energy <span id="pRenewLbl" class="text-slate-400">(€—/t)</span></label>
              <div class="text-xs text-slate-400"><b id="tRenewLbl">50.00</b> t</div>
            </div>
            <input id="tRenew" type="range" min="0" max="100" value="50" class="w-full"/>
            <div class="mt-1 text-[11px] text-slate-400">Includes reforestation, wind, solar, hydro and other renewables (AFOLU & energy).</div>
          </div>

          <div>
            <div class="flex items-center justify-between">
              <label for="tPlastic" class="text-sm text-slate-300">Plastic Credits <span id="pPlasticLbl" class="text-slate-400">(€—/t)</span></label>
              <div class="text-xs text-slate-400"><b id="tPlasticLbl">15.00</b> t</div>
            </div>
            <input id="tPlastic" type="range" min="0" max="100" value="15" class="w-full"/>
          </div>

          <div>
            <div class="flex items-center justify-between">
              <label for="tVCS" class="text-sm text-slate-300">VCUs – VCS v4.4 <span id="pVcsLbl" class="text-slate-400">(€—/t)</span></label>
              <div class="text-xs text-slate-400"><b id="tVCSLbl">10.00</b> t</div>
            </div>
            <input id="tVCS" type="range" min="0" max="100" value="10" class="w-full"/>
          </div>

          <div class="text-xs text-slate-400">Allocated: <b id="allocatedLbl">100.00</b> t • Total: <b id="totalLbl">100</b> t</div>
        </div>

        <!-- Summary KPIs (incl. markup) -->
        <div class="mt-4 grid gap-3 sm:grid-cols-2">
          <div class="rounded-xl border border-white/10 bg-white/5 p-3 sm:p-4"><div class="text-[11px] text-slate-400">Avg. price / t (incl. markup)</div><b id="avgPrice" class="text-base sm:text-lg" role="status" aria-live="polite">–</b></div>
          <div class="rounded-xl border border-white/10 bg-white/5 p-3 sm:p-4"><div class="text-[11px] text-slate-400">Est. subtotal (incl. markup)</div><b id="subtotal" class="text-base sm:text-lg" role="status" aria-live="polite">–</b></div>
        </div>

        <!-- Allocation breakdown -->
        <div class="mt-4 rounded-2xl border border-white/10 bg-white/5 p-3 sm:p-4">
          <div class="flex items-center justify-between">
            <h4 class="text-sm sm:text-base font-semibold">Allocation breakdown</h4>
            <span class="text-[11px] text-slate-400">1 unit = 1 tCO₂e</span>
          </div>
          <div class="mt-2 overflow-x-auto">
            <table class="min-w-[560px] w-full text-left text-sm">
              <thead class="bg-white/5">
                <tr>
                  <th class="px-3 py-2">Category</th>
                  <th class="px-3 py-2">tCO₂</th>
                  <th class="px-3 py-2">% share</th>
                  <th class="px-3 py-2">€/t</th>
                  <th class="px-3 py-2">Subtotal</th>
                </tr>
              </thead>
              <tbody id="breakTbody"></tbody>
            </table>
          </div>
        </div>

        <!-- RFQ link-share UI -->
        <div class="mt-4 space-y-2">
          <div class="text-xs text-slate-400">Shareable RFQ link (auto-updates with your selections)</div>
          <div class="flex flex-col sm:flex-row gap-2">
            <input id="rfqUrl" class="flex-1 rounded-lg border border-white/20 bg-transparent px-3 py-2 text-xs sm:text-sm" readonly value="">
            <div class="flex gap-2">
              <button id="copyLink" class="rounded-full border border-white/20 px-3 py-2 text-xs sm:text-sm hover:shadow-soft">Copy RFQ link</button>
              <button id="openLink" class="rounded-full bg-gradient-to-tr from-brand to-brand-soft px-3 py-2 text-xs sm:text-sm text-brand-dark hover:shadow-soft">Open link</button>
            </div>
          </div>
        </div>

        <div class="mt-4 flex flex-wrap items-center gap-3">
          <button id="addToCart" class="rounded-full bg-gradient-to-tr from-brand to-brand-soft px-4 py-2 text-sm sm:text-base text-brand-dark hover:shadow-soft">Create RFQ & reserve</button>
          <span class="rounded-full border border-white/15 bg-white/5 px-3 py-1 text-[11px] sm:text-xs">White-label ✔</span>
          <span class="rounded-full border border-white/15 bg-white/5 px-3 py-1 text-[11px] sm:text-xs">Registry retirement ✔</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Trust -->
  <section class="mx-auto max-w-[1200px] px-4 sm:px-5 pb-8 sm:pb-10">
    <div class="rounded-2xl border border-white/10 bg-gradient-to-b from-[#12171d] to-[#0f1419] p-4 sm:p-5">
      <div class="flex flex-col gap-5 md:flex-row md:justify-between">
        <div class="md:max-w-[60ch]">
          <h2 class="text-xl sm:text-2xl font-semibold">Built for trust</h2>
          <p class="mt-1 text-slate-300 text-sm sm:text-base">
            Each unit is retired on behalf of the buyer in a recognized registry (e.g., Verra, Gold Standard, ACR, Puro.earth). Every certificate carries a QR link to a public record.
          </p>
          <div class="mt-3 flex flex-wrap gap-2">
            <span class="rounded-full border border-white/15 bg-white/5 px-3 py-1.5 text-xs text-slate-300">Verra VCS</span>
            <span class="rounded-full border border-white/15 bg-white/5 px-3 py-1.5 text-xs text-slate-300">Gold Standard</span>
            <span class="rounded-full border border-white/15 bg-white/5 px-3 py-1.5 text-xs text-slate-300">ACR</span>
            <span class="rounded-full border border-white/15 bg-white/5 px-3 py-1.5 text-xs text-slate-300">Puro.earth</span>
          </div>
          <p class="mt-2 text-[11px] sm:text-xs text-slate-400">
            We support verifiable purchases and retirements of VCUs compliant with Verified Carbon Standard (VCS v4.4). Each VCU equals 1 tCO₂e and is retired on behalf of the buyer in the Verra registry (TXID & public record included).
          </p>
        </div>

        <!-- Verify retirement -->
        <div class="rounded-xl border border-white/10 bg-white/5 p-4 md:min-w-[360px]">
          <h4 class="text-base sm:text-lg font-semibold">Verify a retirement</h4>
          <label for="txid" class="text-[11px] sm:text-xs text-slate-400">Registry URL / TXID</label>
          <input id="txid" placeholder="https://registry.example/tx/…" class="mt-1 w-full rounded-lg border border-white/20 bg-transparent px-3 py-2 text-sm"/>
          <button id="verifyBtn" class="mt-2 rounded-full border border-white/20 px-4 py-2 text-sm hover:shadow-soft">Open record</button>
          <div id="verifyMsg" class="mt-2 text-[11px] sm:text-xs text-slate-400"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Featured projects -->
  <section class="mx-auto max-w-[1200px] px-4 sm:px-5 pb-8 sm:pb-10" id="catalog">
    <h2 class="text-xl sm:text-2xl font-semibold">Featured credits</h2>
    <div class="mt-3 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
      <article class="overflow-hidden rounded-2xl border border-white/10 bg-white/5">
        <img class="h-40 w-full object-cover" width="1200" height="160" src="./biochar.jpg" alt="Biochar removal"/>
        <div class="p-3">
          <b class="block">Biochar Removal • EU</b>
          <div class="mt-2 flex flex-wrap items-center gap-2">
            <a class="rounded-full border border-white/20 px-3 py-1 text-sm hover:shadow-soft" href="#mix">Add to mix</a>
            <span class="rounded-full border border-white/15 bg-white/5 px-2 py-1 text-[11px]">Removal</span>
            <span class="rounded-full border border-white/15 bg-white/5 px-2 py-1 text-[11px]">Vintage 2024</span>
          </div>
        </div>
      </article>

      <article class="overflow-hidden rounded-2xl border border-white/10 bg-white/5">
        <img class="h-40 w-full object-cover" width="1200" height="160" src="./renewables.jpg" alt="Renewable energy"/>
        <div class="p-3">
          <b class="block">Renewable Energy • Global</b>
          <div class="mt-2 flex flex-wrap items-center gap-2">
            <a class="rounded-full border border-white/20 px-3 py-1 text-sm hover:shadow-soft" href="#mix">Add to mix</a>
            <span class="rounded-full border border-white/15 bg-white/5 px-2 py-1 text-[11px]">Renewables</span>
            <span class="rounded-full border border-white/15 bg-white/5 px-2 py-1 text-[11px]">Various vintages</span>
          </div>
        </div>
      </article>

      <article class="overflow-hidden rounded-2xl border border-white/10 bg-white/5">
        <img class="h-40 w-full object-cover" width="1200" height="160" src="./plastic.jpg" alt="Plastic credits"/>
        <div class="p-3">
          <b class="block">Plastic Credits • Global</b>
          <div class="mt-2 flex flex-wrap items-center gap-2">
            <a class="rounded-full border border-white/20 px-3 py-1 text-sm hover:shadow-soft" href="#mix">Add to mix</a>
            <span class="rounded-full border border-white/15 bg-white/5 px-2 py-1 text-[11px]">Plastic</span>
            <span class="rounded-full border border-white/15 bg-white/5 px-2 py-1 text-[11px]">2024</span>
          </div>
        </div>
      </article>

      <article class="overflow-hidden rounded-2xl border border-white/10 bg-white/5">
        <img class="h-40 w-full object-cover" width="1200" height="160" src="./vcs.jpg" alt="VCUs VCS v4.4"/>
        <div class="p-3">
          <b class="block">Verified Carbon Units (VCUs) • Global</b>
          <div class="mt-2 flex flex-wrap items-center gap-2">
            <a class="rounded-full border border-white/20 px-3 py-1 text-sm hover:shadow-soft" href="#mix">Add to mix</a>
            <span class="rounded-full border border-white/15 bg-white/5 px-2 py-1 text-[11px]">VCU</span>
            <span class="rounded-full border border-white/15 bg-white/5 px-2 py-1 text-[11px]">VCS v4.4</span>
          </div>
        </div>
      </article>
    </div>
    <p class="mt-2 text-[11px] sm:text-xs text-slate-400">Prices include volume-based markup and update dynamically in the calculator.</p>
  </section>

  <!-- How it works -->
  <section class="mx-auto max-w-[1200px] px-4 sm:px-5 pb-8 sm:pb-10" id="how">
    <h2 class="text-xl sm:text-2xl font-semibold">How it works</h2>
    <div class="mt-3 grid gap-3 md:grid-cols-4">
      <div class="rounded-xl border border-white/10 bg-white/5 p-4">
        <div class="mb-2 grid h-7 w-7 place-items-center rounded-full bg-brand text-brand-dark font-bold">1</div>
        <b>Sign up & KYC</b>
        <div class="text-xs text-slate-400">We verify buyers & suppliers to protect all parties.</div>
      </div>
      <div class="rounded-xl border border-white/10 bg-white/5 p-4">
        <div class="mb-2 grid h-7 w-7 place-items-center rounded-full bg-brand text-brand-dark font-bold">2</div>
        <b>Create RFQ / Build a mix</b>
        <div class="text-xs text-slate-400">Set volumes and mix rules (removal %, renewables cap, plastic share, VCS split).</div>
      </div>
      <div class="rounded-xl border border-white/10 bg-white/5 p-4">
        <div class="mb-2 grid h-7 w-7 place-items-center rounded-full bg-brand text-brand-dark font-bold">3</div>
        <b>Escrow & validation</b>
        <div class="text-xs text-slate-400">Funds held in escrow while MRV is validated.</div>
      </div>
      <div class="rounded-xl border border-white/10 bg-white/5 p-4">
        <div class="mb-2 grid h-7 w-7 place-items-center rounded-full bg-brand text-brand-dark font-bold">4</div>
        <b>Registry retirement & WL certificate</b>
        <div class="text-xs text-slate-400">We retire units on your behalf and issue a QR-verifiable certificate.</div>
      </div>
    </div>
  </section>

  <!-- Suppliers -->
  <section class="mx-auto max-w-[1200px] px-4 sm:px-5 pb-8 sm:pb-10" id="suppliers">
    <div class="grid gap-6 md:grid-cols-2 items-start">
      <div>
        <h2 class="text-xl sm:text-2xl font-semibold">Suppliers — sell your verified credits</h2>
        <p class="mt-1 text-slate-300 text-sm sm:text-base">List your Verra, Gold Standard, ACR or Puro.earth units (plus plastic under PWRS/PCX). Set capacity and price ranges; we route global demand to you.</p>
        <div class="mt-3 flex flex-wrap gap-2">
          <span class="rounded-full border border-white/15 bg-white/5 px-3 py-1.5 text-xs text-slate-300">White-label agreement</span>
          <span class="rounded-full border border-white/15 bg-white/5 px-3 py-1.5 text-xs text-slate-300">API / CSV upload</span>
          <span class="rounded-full border border-white/15 bg-white/5 px-3 py-1.5 text-xs text-slate-300">Monthly reconcile</span>
          <span class="rounded-full border border-white/15 bg-white/5 px-3 py-1.5 text-xs text-slate-300">Payouts in EUR/USD</span>
        </div>
        <div class="mt-4 flex gap-3">
          <a class="rounded-full bg-gradient-to-tr from-brand to-brand-soft px-4 py-2 text-sm sm:text-base text-brand-dark hover:shadow-soft" href="#cta">Apply as supplier</a>
          <a class="rounded-full border border-white/20 px-4 py-2 text-sm sm:text-base hover:shadow-soft" href="#docs">Read WL manual</a>
        </div>
      </div>
      <div class="rounded-xl border border-white/10 bg-white/5 p-4">
        <h4 class="text-lg font-semibold">Quick supplier checklist</h4>
        <ul class="mt-2 list-disc pl-5 text-xs text-slate-300 space-y-1">
          <li>KYC/KYB completed, beneficial owners disclosed</li>
          <li>Valid MRV package (methodology, vintage, verifier)</li>
          <li>Unique serial ranges; no double-listing</li>
          <li>Agreed SLAs for delivery & audits</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- ESG Reports -->
  <section class="mx-auto max-w-[1200px] px-4 sm:px-5 pb-8 sm:pb-10" id="reports">
    <div class="rounded-2xl border border-white/10 bg-gradient-to-b from-[#12171d] to-[#0f1419] p-4 sm:p-5">
      <h2 class="text-xl sm:text-2xl font-semibold">ESG reporting made simple</h2>
      <p class="mt-1 text-slate-300 text-sm sm:text-base">Export transaction-level data for GHG Protocol scopes 1/2/3 (incl. VCUs under VCS v4.4). Get PDF summaries for CSRD/ESRS and machine-readable CSV/JSON for auditors (ISAE 3000/3410 ready).</p>
      <div class="mt-3 overflow-x-auto rounded-xl border border-white/10">
        <table class="min-w-[720px] w-full text-left text-sm">
          <thead class="bg-white/5">
            <tr><th class="px-4 py-3">Dataset</th><th class="px-4 py-3">Description</th><th class="px-4 py-3">Format</th><th class="px-4 py-3">Action</th></tr>
          </thead>
          <tbody>
            <tr class="border-t border-white/10">
              <td class="px-4 py-3">ESRS mapping</td>
              <td class="px-4 py-3">E1-6 (Scopes 1–3, S2 loc/mkt) & E1-8 (Offsets)</td>
              <td class="px-4 py-3">JSON</td>
              <td class="px-4 py-3">
                <button id="btnExportESRS" class="rounded-full border border-white/20 px-3 py-1 hover:shadow-soft">Download</button>
              </td>
            </tr>
            <tr class="border-t border-white/10">
              <td class="px-4 py-3">Certificate bundle</td>
              <td class="px-4 py-3">All WL certificates incl. QR</td>
              <td class="px-4 py-3">PDF/A</td>
              <td class="px-4 py-3"><button class="rounded-full border border-white/20 px-3 py-1 hover:shadow-soft">Download</button></td>
            </tr>
            <tr class="border-t border-white/10">
              <td class="px-4 py-3">Transactions</td>
              <td class="px-4 py-3">Line-items with unit IDs & TXIDs</td>
              <td class="px-4 py-3">CSV</td>
              <td class="px-4 py-3">
                <button id="btnExportCSV" class="rounded-full border border-white/20 px-3 py-1 hover:shadow-soft">Export</button>
              </td>
            </tr>
            <tr class="border-t border-white/10">
              <td class="px-4 py-3">API access</td>
              <td class="px-4 py-3">Webhook + OAuth2 client</td>
              <td class="px-4 py-3">JSON</td>
              <td class="px-4 py-3"><button class="rounded-full border border-white/20 px-3 py-1 hover:shadow-soft">Generate keys</button></td>
            </tr>
          </tbody>
        </table>
      </div>
      <p class="mt-2 text-[11px] sm:text-xs text-slate-400">ESRS export includes Scope 2 market-based if provided; otherwise left null. All exports generated client-side.</p>
    </div>
  </section>

  <!-- CTA -->
  <section class="mx-auto max-w-[1200px] px-4 sm:px-5 pb-12 sm:pb-14" id="cta">
    <div class="rounded-2xl border border-white/10 bg-gradient-to-b from-[#12171d] to-[#0f1419] p-4 sm:p-5">
      <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
          <h2 class="text-xl sm:text-2xl font-semibold">Ready to offset — or to sell?</h2>
          <p class="mt-1 text-slate-300 text-sm sm:text-base">Join ESGOffset and access a global marketplace with escrow, KYC and registry retirement built-in.</p>
          <div class="mt-3 flex gap-3">
            <a class="rounded-full bg-gradient-to-tr from-brand to-brand-soft px-4 py-2 text-sm sm:text-base text-brand-dark hover:shadow-soft" href="#mix">Start offsetting</a>
            <a class="rounded-full border border-white/20 px-4 py-2 text-sm sm:text-base hover:shadow-soft" href="#suppliers">Become a supplier</a>
          </div>
        </div>
        <div class="rounded-xl border border-white/10 bg-white/5 p-4 w-fit">
          <div class="text-xs text-slate-400">Uptime (30d)</div><b class="text-lg">99.98%</b>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Footer -->
<footer class="border-t border-white/10 bg-[#0a0f13] py-7">
  <div class="mx-auto max-w-[1200px] px-4 sm:px-5 grid gap-6 md:grid-cols-4">
    <div>
      <div class="flex items-center gap-2">
        <svg class="w-7 h-7" viewBox="0 0 24 24" aria-hidden="true"><path fill="#00a36c" d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2m4.5 6.5L12 13l-2.5-2.5l-3 3L12 19l7.5-7.5Z"/></svg>
        <span class="font-semibold">ESG Offset Partners</span>
      </div>
      <p class="mt-2 text-xs text-slate-400">© <span id="yr"></span> ESGOffset.com — All rights reserved.</p>
      <div class="mt-2 flex flex-wrap gap-2">
        <span class="rounded-full border border-white/15 bg-white/5 px-3 py-2 text-xs text-slate-300">GDPR</span>
        <span class="rounded-full border border-white/15 bg-white/5 px-3 py-2 text-xs text-slate-300">KYC/AML</span>
        <span class="rounded-full border border-white/15 bg-white/5 px-3 py-2 text-xs text-slate-300">Escrow</span>
        <span class="rounded-full border border-white/15 bg-white/5 px-3 py-2 text-xs text-slate-300">ISO 27001 (roadmap)</span>
      </div>
    </div>
    <div>
      <b>Company</b><br/>
      <a class="block mt-1 opacity-90 hover:opacity-100" href="#about">About</a>
      <a class="block opacity-90 hover:opacity-100" href="#careers">Careers</a>
      <a class="block opacity-90 hover:opacity-100" href="#press">Press</a>
    </div>
    <div>
      <b>Legal</b><br/>
      <a class="block mt-1 opacity-90 hover:opacity-100" href="#terms">Terms</a>
      <a class="block opacity-90 hover:opacity-100" href="#privacy">Privacy</a>
      <a class="block opacity-90 hover:opacity-100" href="#cookies">Cookies</a>
    </div>
    <div>
      <b>Contact</b><br/>
      <a class="block mt-1 opacity-90 hover:opacity-100" href="mailto:hello@esgoffset.com">hello@esgoffset.com</a>
      <a class="block opacity-90 hover:opacity-100" href="#support">Support</a>
    </div>
  </div>
</footer>

<!-- Cookie consent -->
<div id="cookie" role="dialog" aria-live="polite" aria-label="Cookie consent"
     class="fixed bottom-4 left-4 right-4 z-[9999] hidden items-center justify-between gap-3 rounded-2xl border border-white/15 bg-white/5 p-4 shadow-soft md:left-auto md:w-[520px]">
  <div class="text-sm text-slate-200">We use cookies for analytics and a better experience. <a href="#" id="cookiePrefs" class="underline decoration-white/40">Manage preferences</a></div>
  <div class="flex gap-2">
    <button class="rounded-full border border-white/20 px-4 py-2" id="cookieDecline">Decline</button>
    <button class="rounded-full bg-gradient-to-tr from-brand to-brand-soft px-4 py-2 text-brand-dark" id="cookieAccept">Accept</button>
  </div>
</div>

<script>
  // ---------- Shorthands ----------
  const $ = s => document.querySelector(s);
  const fmtEUR = x => new Intl.NumberFormat(undefined,{style:'currency',currency:'EUR'}).format(x);
  const clamp = (n,min,max)=> Math.max(min, Math.min(max, n));
  const dl = (name, mime, content)=>{
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([content], {type:mime}));
    a.download = name; document.body.appendChild(a); a.click(); a.remove();
  };

  // ---------- Header & misc ----------
  const drawer = $('#drawer');
  $('#menuBtn')?.addEventListener('click', ()=> drawer.classList.remove('hidden'));
  $('#menuClose')?.addEventListener('click', ()=> drawer.classList.add('hidden'));
  $('#drawerBackdrop')?.addEventListener('click', ()=> drawer.classList.add('hidden'));

  // Verify retirement
  $('#verifyBtn')?.addEventListener('click', ()=>{
    const v=$('#txid').value.trim(); const m=$('#verifyMsg');
    if(!v){ m.textContent='Enter a registry URL or TXID.'; m.className='mt-2 text-xs text-red-400'; return; }
    try{
      if(/^https?:\/\//i.test(v)) window.open(v,'_blank','noopener,noreferrer');
      else { m.innerHTML=`Search your registry for TXID: <b>${v}</b>`; m.className='mt-2 text-xs text-emerald-400'; }
    }catch(e){ m.textContent='Unable to open. Copy & paste into registry.'; m.className='mt-2 text-xs text-red-400';}
  });

  // Cookie consent
  const cookieId='esg-cookie';
  function showCookie(){ if(!localStorage.getItem(cookieId)) $('#cookie').classList.remove('hidden'); }
  $('#cookieAccept').onclick=()=>{ localStorage.setItem(cookieId,'1'); $('#cookie').classList.add('hidden'); };
  $('#cookieDecline').onclick=()=>{ $('#cookie').classList.add('hidden'); };
  $('#cookiePrefs').onclick=(e)=>{ e.preventDefault(); alert('Preferences modal (analytics/marketing) – to be implemented.'); };
  showCookie();

  // Footer year
  document.getElementById('yr').textContent=new Date().getFullYear();

  // Login demo
  document.getElementById('loginBtn')?.addEventListener('click', ()=>alert('Auth modal here (OAuth2/OIDC + 2FA)'));
  document.getElementById('loginBtnM')?.addEventListener('click', ()=>alert('Auth modal here (OAuth2/OIDC + 2FA)'));

  // ---------- BASE PRICES (editable in your internal tool) ----------
  const BASE_PRICES = { biochar:123, renew:4, plastic:200, vcs:4 };

  // ---------- MARKUP TIERS (applied on top of base) ----------
  // ≤10 t: +50%, ≤1000 t: +25%, ≤100000 t: +15%, >100000 t: +10%
  const MARKUP_TIERS = [
    { min:1,       max:10,       pct:0.50 },
    { min:11,      max:1000,     pct:0.25 },
    { min:1001,    max:100000,   pct:0.15 },
    { min:100001,  max:Infinity, pct:0.10 },
  ];
  function markupPct(totalTons){
    const t = Math.max(1, Number(totalTons)||1);
    const tier = MARKUP_TIERS.find(x => t>=x.min && t<=x.max) || MARKUP_TIERS[MARKUP_TIERS.length-1];
    return tier.pct;
  }
  function tierName(totalTons){
    const t = Math.max(1, Number(totalTons)||1);
    if(t<=10) return 'Tier A (≤10 t, +50%)';
    if(t<=1000) return 'Tier B (11–1,000 t, +25%)';
    if(t<=100000) return 'Tier C (1,001–100,000 t, +15%)';
    return 'Tier D (100,001+ t, +10%)';
  }
  // final €/t shown to users = base * (1 + markupPct)
  function unitPrice(kind, totalTons){
    return BASE_PRICES[kind] * (1 + markupPct(totalTons));
  }

  // ---------- Calculator refs ----------
  const tTotal   = $('#tonnes');
  const sBiochar = $('#tBiochar');
  const sRenew   = $('#tRenew');
  const sPlastic = $('#tPlastic');
  const sVCS     = $('#tVCS');

  const lBiochar = $('#tBiocharLbl');
  const lRenew   = $('#tRenewLbl');
  const lPlastic = $('#tPlasticLbl');
  const lVCS     = $('#tVCSLbl');

  const prBiochar = $('#pBiocharLbl');
  const prRenew   = $('#pRenewLbl');
  const prPlastic = $('#pPlasticLbl');
  const prVcs     = $('#pVcsLbl');

  const lRemain  = $('#remainLabel');
  const barRemain= $('#remainBar');
  const lAlloc   = $('#allocatedLbl');
  const lTotal   = $('#totalLbl');
  const tierNote = $('#tierNote');

  const rfqInput = $('#rfqUrl');

  function getAllocations(){
    return {
      total: Math.max(1, parseFloat(tTotal.value)||0),
      biochar: parseFloat(sBiochar.value)||0,
      renew:   parseFloat(sRenew.value)||0,
      plastic: parseFloat(sPlastic.value)||0,
      vcs:     parseFloat(sVCS.value)||0,
    };
  }
  function syncSliderMax(){
    const T = Math.max(1, parseFloat(tTotal.value)||0);
    [sBiochar,sRenew,sPlastic,sVCS].forEach(sl=> sl.max = String(T));
    lTotal.textContent = T;
  }

  function recalcAll(){
    const a = getAllocations();
    const allocated = a.biochar + a.renew + a.plastic + a.vcs;
    const remaining = clamp(a.total - allocated, 0, a.total);

    // dynamic €/t incl. markup
    const pb = unitPrice('biochar', a.total);
    const pr = unitPrice('renew',   a.total);
    const pp = unitPrice('plastic', a.total);
    const pv = unitPrice('vcs',     a.total);

    // update labels
    prBiochar.textContent = `(${fmtEUR(pb)}/t)`;
    prRenew.textContent   = `(${fmtEUR(pr)}/t)`;
    prPlastic.textContent = `(${fmtEUR(pp)}/t)`;
    prVcs.textContent     = `(${fmtEUR(pv)}/t)`;
    tierNote.textContent = `Volume-based pricing with built-in markup. Current tier: ${tierName(a.total)}. €/t with markup → Biochar ${fmtEUR(pb)}, Renewable ${fmtEUR(pr)}, Plastic ${fmtEUR(pp)}, VCS ${fmtEUR(pv)}.`;

    // UI numbers
    lBiochar.textContent = a.biochar.toFixed(2);
    lRenew.textContent   = a.renew.toFixed(2);
    lPlastic.textContent = a.plastic.toFixed(2);
    lVCS.textContent     = a.vcs.toFixed(2);

    lAlloc.textContent   = allocated.toFixed(2);
    lRemain.textContent  = remaining.toFixed(2);
    barRemain.style.width = `${clamp(remaining / a.total * 100, 0, 100)}%`;

    // costs (incl. markup)
    const subtotal = a.biochar*pb + a.renew*pr + a.plastic*pp + a.vcs*pv;
    const avg = subtotal / Math.max(1, a.total);

    $('#avgPrice').textContent = fmtEUR(avg);
    $('#subtotal').textContent = fmtEUR(subtotal);

    renderBreakdown(a, {pb,pr,pp,pv});
    updateShareUrl(a, {pb,pr,pp,pv});
  }

  function onSlide(sliderKey){
    const a = getAllocations();
    const others = ['biochar','renew','plastic','vcs'].filter(k=>k!==sliderKey).reduce((sum,k)=> sum + a[k], 0);
    const room = clamp(a.total - others, 0, a.total);
    let newVal = a[sliderKey];
    if(newVal > room) newVal = room;
    a[sliderKey] = newVal;

    sBiochar.value = a.biochar;
    sRenew.value   = a.renew;
    sPlastic.value = a.plastic;
    sVCS.value     = a.vcs;

    recalcAll();
  }

  function renderBreakdown(a, p){
    const rows = [
      { label:'Biochar', price:p.pb, t:a.biochar },
      { label:'Renewable Energy', price:p.pr, t:a.renew },
      { label:'Plastic Credits', price:p.pp, t:a.plastic },
      { label:'VCUs (VCS v4.4)', price:p.pv, t:a.vcs },
    ].map(r=>{
      const share = (r.t / a.total) * 100;
      const sub   = r.t * r.price;
      return `<tr class="border-t border-white/10">
        <td class="px-3 py-2">${r.label}</td>
        <td class="px-3 py-2">${r.t.toFixed(2)}</td>
        <td class="px-3 py-2">${share.toFixed(1)}%</td>
        <td class="px-3 py-2">${fmtEUR(r.price)}</td>
        <td class="px-3 py-2">${fmtEUR(sub)}</td>
      </tr>`;
    }).join('');
    $('#breakTbody').innerHTML = rows;
  }

  function updateShareUrl(a, p){
    const params = new URLSearchParams({
      t: a.total, bT: a.biochar, rT: a.renew, pT: a.plastic, vT: a.vcs,
      pb:p.pb.toFixed(2), pr:p.pr.toFixed(2), pp:p.pp.toFixed(2), pv:p.pv.toFixed(2),
      mk: markupPct(a.total)
    });
    const existing = getParamsFromPage();
    if(existing.get('src')) params.set('src', existing.get('src'));
    const base = location.origin + location.pathname + '#mix';
    rfqInput.value = `${base}?${params.toString()}`;
  }
  function getParamsFromPage(){
    if(location.hash && location.hash.includes('?')) return new URLSearchParams(location.hash.split('?')[1]);
    return new URLSearchParams(location.search);
  }

  function syncFromUrlOrDefaults(){
    const sp = getParamsFromPage();
    if([...sp.keys()].length === 0){
      syncSliderMax();
      sBiochar.value = 25; sRenew.value = 50; sPlastic.value = 15; sVCS.value = 10;
      recalcAll(); return;
    }
    if(sp.get('t')) tTotal.value = Math.max(1, parseFloat(sp.get('t'))||100);
    syncSliderMax();

    const bT = sp.get('bT'), rT=sp.get('rT'), pT=sp.get('pT'), vT=sp.get('vT');
    if(bT || rT || pT || vT){
      const T = parseFloat(tTotal.value)||100;
      if(bT) sBiochar.value = clamp(parseFloat(bT)||0, 0, T);
      if(rT) sRenew.value   = clamp(parseFloat(rT)||0, 0, T);
      if(pT) sPlastic.value = clamp(parseFloat(pT)||0, 0, T);
      if(vT) sVCS.value     = clamp(parseFloat(vT)||0, 0, T);
    }else{
      // percent fallback (legacy)
      const b = parseFloat(sp.get('b')||'')||0;
      const r = parseFloat(sp.get('r')||'')||0;
      const p = parseFloat(sp.get('p')||'')||0;
      const v = parseFloat(sp.get('v')||'')||0;
      const sum = (b+r+p+v)||100;
      const T = parseFloat(tTotal.value)||100;
      sBiochar.value = T * (b/sum);
      sRenew.value   = T * (r/sum);
      sPlastic.value = T * (p/sum);
      sVCS.value     = T * (v/sum);
    }
    capIfOverTotal();
    recalcAll();
  }

  function capIfOverTotal(){
    const a = getAllocations();
    let over = a.biochar + a.renew + a.plastic + a.vcs - a.total;
    if(over <= 0) return;
    const order = [{sl:sVCS},{sl:sRenew},{sl:sPlastic},{sl:sBiochar}];
    for(const it of order){
      if(over <= 0) break;
      const cur = parseFloat(it.sl.value)||0;
      const take = Math.min(cur, over);
      it.sl.value = cur - take;
      over -= take;
    }
  }

  // Events for sliders / total
  tTotal.addEventListener('input', ()=>{ syncSliderMax(); capIfOverTotal(); recalcAll(); });
  sBiochar.addEventListener('input', ()=> onSlide('biochar'));
  sRenew.addEventListener('input',   ()=> onSlide('renew'));
  sPlastic.addEventListener('input', ()=> onSlide('plastic'));
  sVCS.addEventListener('input',     ()=> onSlide('vcs'));

  // RFQ link buttons
  $('#copyLink').addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText($('#rfqUrl').value); alert('RFQ link copied to clipboard.'); }
    catch(e){ $('#rfqUrl').select(); document.execCommand('copy'); alert('RFQ link copied.'); }
  });
  $('#openLink').addEventListener('click', ()=> window.open($('#rfqUrl').value,'_blank','noopener,noreferrer'));

  // ---------- AI Mix Advisor: presety & aplikácia ----------
  function applyPreset(pct){ // pct v %
    const T = Math.max(1, parseFloat(tTotal.value)||0);
    const b = Math.round(T * (pct.b||0)/100);
    const r = Math.round(T * (pct.r||0)/100);
    const p = Math.round(T * (pct.p||0)/100);
    let v = T - (b+r+p); if(v<0) v=0;
    sBiochar.value=b; sRenew.value=r; sPlastic.value=p; sVCS.value=v;
    recalcAll();
  }

  const GOAL = {
    balanced: {b:25,r:50,p:15,v:10},
    removal:  {b:45,r:35,p:5, v:15},
    cost:     {b:10,r:70,p:5, v:15},
    plastic:  {b:15,r:40,p:35,v:10},
    brand:    {b:30,r:40,p:15,v:15},
    science:  {b:55,r:25,p:5, v:15}
  };
  const IND = {
    tech:          {b:+5,  r:+5,  p:-5, v:-5},
    manufacturing: {b:+10, r:-5,  p:+0, v:-5},
    ecommerce:     {b:+0,  r:+0,  p:+10, v:-10},
    fmcg:          {b:+0,  r:-5,  p:+10, v:-5},
    utilities:     {b:+5,  r:+10, p:-5, v:-10},
    logistics:     {b:+10, r:+10, p:+5,  v:-25},
    aviation:      {b:+15, r:+0,  p:+0,  v:-15},
    construction:  {b:+10, r:+0,  p:+0,  v:-10},
    finance:       {b:+5,  r:+5,  p:+0,  v:-10},
    public:        {b:+5,  r:+5,  p:+5,  v:-15},
    other:         {}
  };

  document.getElementById('aiApply').addEventListener('click', ()=>{
    const ind = document.getElementById('aiIndustry').value;
    const goal = document.getElementById('aiGoal').value;
    const base = GOAL[goal] || GOAL.balanced;
    const mod  = IND[ind] || {};
    let pct = {
      b: Math.max(0, (base.b + (mod.b||0))),
      r: Math.max(0, (base.r + (mod.r||0))),
      p: Math.max(0, (base.p + (mod.p||0))),
      v: Math.max(0, (base.v + (mod.v||0)))
    };
    const sum = pct.b + pct.r + pct.p + pct.v || 100;
    pct = { b:100*pct.b/sum, r:100*pct.r/sum, p:100*pct.p/sum, v:100*pct.v/sum };
    applyPreset(pct);
  });

  // ---------- AI Mix Advisor: template na stiahnutie ----------
  document.getElementById('downloadTemplate').addEventListener('click', ()=>{
    const rows = [
      'scope,amount_t,category',
      'S1,120,Boilers',
      'S2,300,Electricity (location-based)',
      'S3,950,Upstream logistics'
    ].join('\n');
    dl('emissions_template.csv','text/csv;charset=utf-8',rows);
  });

  // ---------- Robust Analyze (CSV/XLSX) ----------
  const det = { s1:null, s2_loc:null, s2_mkt:null, s3:null, total:null, suggestedMix:null };

  document.getElementById('aiAnalyzeBtn').addEventListener('click', async ()=>{
    try{
      const file = $('#fileInput').files[0];
      let rows = null;

      if(file){
        const buf = await file.arrayBuffer();
        if(/\.(xlsx|xls)$/i.test(file.name)){
          const wb = XLSX.read(buf, {type:'array'});
          // použijeme najväčší sheet
          let best = [], maxLen = -1;
          for(const sn of wb.SheetNames){
            const js = XLSX.utils.sheet_to_json(wb.Sheets[sn], {raw:true, defval:''});
            if(js.length>maxLen){ maxLen=js.length; best=js; }
          }
          rows = best;
        }else{
          const text = new TextDecoder('utf-8').decode(buf);
          rows = parseCSV(text);
        }
      }else{
        const raw = $('#csvTextarea').value.trim();
        if(raw) rows = parseCSV(raw);
      }

      if(!rows || rows.length===0) throw new Error('File empty or no rows detected');

      const agg = aggregateEmissions(rows);
      if(!agg || (agg.s1===0 && agg.s2_loc===0 && agg.s3===0 && agg.s2_mkt===null))
        throw new Error('No Scope 1/2/3 numbers detected in supported columns');

      det.s1 = round(agg.s1);
      det.s2_loc = round(agg.s2_loc);
      det.s2_mkt = (agg.s2_mkt===null? null : round(agg.s2_mkt));
      det.s3 = round(agg.s3);
      det.total = round((det.s1||0)+(det.s2_loc||0)+(det.s3||0)); // default: location-based

      // zobraz "Detected totals"
      $('#detS1').textContent = isNum(det.s1) ? det.s1 : '—';
      $('#detS2L').textContent = isNum(det.s2_loc) ? det.s2_loc : '—';
      $('#detS2M').textContent = isNum(det.s2_mkt) ? det.s2_mkt : '—';
      $('#detS3').textContent = isNum(det.s3) ? det.s3 : '—';

      // navrh mixu
      const s1 = det.s1||0, s2 = det.s2_loc||0, s3 = det.s3||0;
      const sum = (s1+s2+s3)||1, s2p=s2/sum, s3p=s3/sum;
      const flags = agg.flags || {};
      let mix = {b:25, r:50, p:15, v:10};
      mix.b += Math.round(20*s3p);
      mix.r += Math.round(20*s2p);
      if(flags.plasticsHeavy) mix.p = Math.min(40, mix.p+10);
      const mSum = mix.b+mix.r+mix.p+mix.v;
      mix = { b:100*mix.b/mSum, r:100*mix.r/mSum, p:100*mix.p/mSum, v:100*mix.v/mSum };

      det.suggestedMix = mix;
      const suggestedTotal = det.total>0 ? det.total : Math.max(1, parseFloat(tTotal.value)||100);
      $('#suggTotal').textContent = suggestedTotal.toLocaleString(undefined,{maximumFractionDigits:0});
      $('#suggMix').textContent = `Biochar ${mix.b.toFixed(0)}% • Renew ${mix.r.toFixed(0)}% • Plastic ${mix.p.toFixed(0)}% • VCS ${mix.v.toFixed(0)}%`;
      $('#applySuggestion').disabled = false;
      $('#applySuggestion').onclick = ()=>{
        tTotal.value = Math.max(1, Math.round(suggestedTotal));
        syncSliderMax(); applyPreset(mix); window.location.hash = '#mix';
      };

    }catch(err){
      alert(`Analyze file zlyhalo.\nDôvod: ${err.message}\n\nTipy:\n• Akceptujeme široké (totals) aj riadkové tabuľky.\n• Hlavičky môžu byť: scope / amount_t alebo totals: scope1, scope2 (location/market), scope3.\n• Množstvo: amount_t, t, tco2e, emissions, quantity, tonnes, tons…\n• CSV podporuje , aj ; a aj Excel (.xlsx).`);
      console.error('Analyze error:', err);
    }
  });

  // ---------- Helpers: CSV, čísla, agregátor ----------
  function normalizeKey(s){
    return String(s||'')
      .trim()
      .replace(/\uFEFF/g,'')                                 // BOM
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')       // diakritika
      .toLowerCase()
      .replace(/\s+/g,' ')
      .replace(/[^a-z0-9 _-]/g,'');
  }
  function parseCSV(text){
    if(!text) return [];
    const firstLine = text.split(/\r?\n/)[0]||'';
    const delim = (firstLine.split(';').length > firstLine.split(',').length) ? ';' : ',';
    const rows = [];
    const re = new RegExp(`(${delim})(?=(?:[^"]*"[^"]*")*[^"]*$)`);
    const lines = text.replace(/\uFEFF/g,'').split(/\r?\n/).filter(l=>l.trim()!=='');
    if(lines.length===0) return [];
    const header = lines[0].split(re).filter(s=>s!==delim).map(h=>normalizeKey(h.replace(/^"|"$/g,'')));
    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split(re).filter(s=>s!==delim).map(v=>v.replace(/^"|"$/g,'').trim());
      const obj = {};
      header.forEach((h,idx)=> obj[h]= (cols[idx]??''));
      rows.push(obj);
    }
    return rows;
  }
  function num(v){
    if(v===undefined||v===null) return 0;
    let s = String(v).trim();
    if(s==='') return 0;
    const neg = /^\(.*\)$/.test(s);      // (123) -> -123
    s = s.replace(/[()]/g,'');
    s = s.replace(/\s+/g,'').replace(/(?<=\d)[,](?=\d{3}\b)/g,''); // tisícky
    s = s.replace(/,/g,'.');             // desatinná čiarka
    const x = Number(s);
    return isNaN(x) ? 0 : (neg ? -x : x);
  }
  function isNum(v){ return typeof v==='number' && isFinite(v); }
  function round(v){ return isNum(v) ? Math.round((v + Number.EPSILON)*1000)/1000 : null; }

  // Akceptujeme:
  // A) široké totals: scope1 / scope2 location / scope2 market / scope3
  // B) riadkové: scope + amount_t (+ category)
  function aggregateEmissions(rows){
    const norm = rows.map(r=>{
      const rr={}; Object.keys(r).forEach(k=> rr[normalizeKey(k)] = r[k]); return rr;
    });

    // pokus o "široký" formát (aspoň jeden z totals kľúčov)
    const totalsKeys = [
      'scope1','scope_1','scope 1','s1','scope1_t','scope1 (t)','scope1 t',
      'scope2 location','scope2 (location)','scope2_location','s2 location','scope2 loc','location-based','location based',
      'scope2 market','scope2 (market)','scope2_market','s2 market','market-based','market based',
      'scope3','scope_3','scope 3','s3','scope3_t','scope3 (t)','scope3 t'
    ].map(normalizeKey);

    const maybeWide = norm.find(r=> Object.keys(r).some(k=> totalsKeys.includes(k)));
    if(maybeWide){
      const pick = (r, list)=> {
        for(const k of list){ const nk=normalizeKey(k); if(r[nk]!==undefined) return num(r[nk]); }
        return 0;
      };
      const s1 = pick(maybeWide, ['scope1','scope_1','scope 1','s1','scope1_t','scope1 (t)','scope1 t']);
      const s2_loc = pick(maybeWide, ['scope2 location','scope2 (location)','scope2_location','s2 location','scope2 loc','location-based','location based']);
      const s2_mkt = (()=>{
        for(const k of ['scope2 market','scope2 (market)','scope2_market','s2 market','market-based','market based']){
          const nk=normalizeKey(k); if(maybeWide[nk]!==undefined) return num(maybeWide[nk]);
        }
        return null;
      })();
      const s3 = pick(maybeWide, ['scope3','scope_3','scope 3','s3','scope3_t','scope3 (t)','scope3 t']);
      return { s1, s2_loc, s2_mkt, s3, flags:{plasticsHeavy:false} };
    }

    // riadkový formát
    const sKeys = ['scope','scopes','ghg scope','emission scope','scope category','category scope','scope_id'];
    const aKeys = ['amount_t','amount','t','tco2e','co2e_t','emissions','emissions_t','quantity','tonnes','tons','volume'];
    const cKeys = ['category','name','activity','description','ghg category','lineitem','item'];

    // nájdeme skutočné názvy stĺpcov
    const sample = norm[0]||{};
    const findCol = (cands)=> cands.map(normalizeKey).find(k => sample[k]!==undefined) || null;
    const scopeCol = findCol(sKeys);
    const amountCol = findCol(aKeys);
    const categoryCol = findCol(cKeys);

    let s1=0, s2_loc=0, s3=0; let s2_mkt=null; let plasticsHeavy=false;

    if(!scopeCol || !amountCol){
      // fallback: skúsime prvý numerický stĺpec ako "amount" a iný textový ako "scope"
      const keys = Object.keys(sample);
      const maybeAmt = keys.find(k=> isFinite(num(sample[k])));
      const maybeScope = keys.find(k=> /scope|s[123]|direct|indirect/i.test(k));
      if(maybeAmt && maybeScope){
        for(const r of norm){
          const sc = String(r[maybeScope]||'').toLowerCase();
          const amt = num(r[maybeAmt]);
          if(!isFinite(amt)) continue;
          if(/s1|scope ?1|direct/.test(sc)) s1 += amt;
          else if(/s2|scope ?2/.test(sc)) {
            const all = JSON.stringify(r).toLowerCase();
            if(/market/.test(all)) s2_mkt = (s2_mkt||0)+amt;
            else s2_loc += amt;
          } else if(/s3|scope ?3|indirect/.test(sc)) s3 += amt;
        }
        return { s1, s2_loc, s2_mkt, s3, flags:{plasticsHeavy:false} };
      }
      // nič rozumné sme nenašli
      return { s1:0, s2_loc:0, s2_mkt:null, s3:0, flags:{plasticsHeavy:false} };
    }

    for(const r of norm){
      const sc = String(r[scopeCol]||'').toLowerCase();
      const amt = num(r[amountCol]);
      if(!isFinite(amt)) continue;
      if(/s1|scope ?1|direct/.test(sc)) s1 += amt;
      else if(/s2|scope ?2/.test(sc)){
        const all = JSON.stringify(r).toLowerCase();
        if(/market/.test(all)) s2_mkt = (s2_mkt||0) + amt;
        else s2_loc += amt;
      }
      else if(/s3|scope ?3|indirect/.test(sc)) s3 += amt;

      if(categoryCol){
        const cat = String(r[categoryCol]||'').toLowerCase();
        if(cat.includes('plastic') || cat.includes('polymer')) plasticsHeavy = true;
      }
    }
    return { s1, s2_loc, s2_mkt, s3, flags:{plasticsHeavy} };
  }

  // ---------- ESRS / CSV exporty ----------
  function collectModelSnapshot(){
    // detekované aktivity (ak Analyze neprebehlo, sú 0/null)
    const s1 = det.s1 ?? 0;
    const s2_loc = det.s2_loc ?? 0;
    const s2_mkt = (det.s2_mkt===null? null : det.s2_mkt);
    const s3 = det.s3 ?? 0;

    // mix & ceny
    const a = getAllocations();
    const prices = {
      biochar: unitPrice('biochar', a.total),
      renew:   unitPrice('renew',   a.total),
      plastic: unitPrice('plastic', a.total),
      vcs:     unitPrice('vcs',     a.total),
      markup_pct: markupPct(a.total)
    };
    const lines = [
      { product:'Biochar',        t:a.biochar, eur_per_t:prices.biochar },
      { product:'Renewable',      t:a.renew,   eur_per_t:prices.renew },
      { product:'Plastic',        t:a.plastic, eur_per_t:prices.plastic },
      { product:'VCUs VCS v4.4',  t:a.vcs,     eur_per_t:prices.vcs },
    ];
    const offsets_purchased_t = a.biochar + a.renew + a.plastic + a.vcs;
    const subtotal_eur = lines.reduce((s,x)=> s + x.t*x.eur_per_t, 0);
    const avg_cost_eur_t = offsets_purchased_t>0 ? subtotal_eur/offsets_purchased_t : 0;

    return {
      esrs_version: "ESRS 1.0",
      mix_lines: lines,
      prices,
      totals: { subtotal_eur, avg_cost_eur_t, offsets_purchased_t },
      e1_6: {
        scope1_t: s1,
        scope2_location_t: s2_loc,
        scope2_market_t: s2_mkt, // môže byť null
        scope3_t: s3
      },
      e1_8: {
        offsets_purchased_t,
        avg_cost_eur_t,
        subtotal_eur
      }
    };
  }

  document.getElementById('btnExportESRS').addEventListener('click', ()=>{
    const snapshot = collectModelSnapshot();
    const pretty = JSON.stringify(snapshot, null, 2);
    dl('esrs_snapshot.json','application/json;charset=utf-8', pretty);
  });

  document.getElementById('btnExportCSV').addEventListener('click', ()=>{
    const snap = collectModelSnapshot();
    const rows = [
      ['product','t','eur_per_t','subtotal_eur'],
      ...snap.mix_lines.map(l=>[
        l.product,
        l.t.toFixed(3),
        l.eur_per_t.toFixed(2),
        (l.t*l.eur_per_t).toFixed(2)
      ]),
      [],
      ['scope1_t','scope2_location_t','scope2_market_t','scope3_t'],
      [
        (snap.e1_6.scope1_t||0),
        (snap.e1_6.scope2_location_t||0),
        (snap.e1_6.scope2_market_t==null?'':snap.e1_6.scope2_market_t),
        (snap.e1_6.scope3_t||0)
      ],
      [],
      ['offsets_purchased_t','avg_cost_eur_t','subtotal_eur'],
      [
        snap.totals.offsets_purchased_t,
        snap.totals.avg_cost_eur_t.toFixed(2),
        snap.totals.subtotal_eur.toFixed(2)
      ]
    ];
    const csv = rows.map(r=> r.map(x=>{
      const s = String(x);
      return /[",;\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(',')).join('\n');
    dl('mix_export.csv','text/csv;charset=utf-8', csv);
  });

  // --- Initialise calculator from URL or defaults ---
  function init(){
    syncFromUrlOrDefaults();
    recalcAll();
  }
  init();
</script>
</body>
</html>
